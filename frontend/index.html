<!DOCTYPE ahtml>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ecf0f1;
        }
        .password-toggle {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <!-- User Profile in a Fixed Position -->
    <div id="profileContainer" class="hidden fixed top-4 right-4 z-50">
        <div class="group relative flex items-center cursor-pointer">
            <div class="w-12 h-12 bg-blue-500 text-white flex items-center justify-center rounded-full text-xl font-bold shadow-md">
                <span id="profileInitials"></span>
            </div>
            <div class="absolute right-0 top-full mt-2 w-max p-4 bg-white rounded-xl shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none group-hover:pointer-events-auto origin-top-right">
                <p class="font-bold text-gray-800"><span id="profileUsername"></span></p>
                <p class="text-sm text-gray-600"><span id="profileEmail"></span></p>
            </div>
        </div>
    </div>
    
    <!-- Main Content Container -->
    <div class="w-full max-w-2xl bg-white rounded-xl shadow-lg p-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">My Task Manager</h1>

        <!-- Auth Section -->
        <div id="authContainer">
            <div id="loginSection">
                <div class="max-w-md mx-auto p-6 bg-gray-50 rounded-lg shadow-md">
                    <h3 class="text-2xl font-semibold text-center text-gray-700 mb-4">Login</h3>
                    <div id="loginMessage" class="hidden p-3 rounded-md text-sm mb-4"></div>
                    <form id="loginForm" class="space-y-4">
                        <input type="text" id="loginUsername" placeholder="Username or Email" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="relative">
                            <input type="password" id="loginPassword" placeholder="Password" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button type="button" class="password-toggle text-blue-500 hover:text-blue-700">Show</button>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 text-white p-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Log In</button>
                    </form>
                    <p class="text-center text-sm text-gray-600 mt-4">Don't have an account? <a href="#" id="showSignupLink" class="text-blue-500 hover:underline">Sign Up</a></p>
                </div>
            </div>

            <div id="signupSection" class="hidden">
                <div class="max-w-md mx-auto p-6 bg-gray-50 rounded-lg shadow-md">
                    <h3 class="text-2xl font-semibold text-center text-gray-700 mb-4">Sign Up</h3>
                    <div id="signupMessage" class="hidden p-3 rounded-md text-sm mb-4"></div>
                    <form id="signupForm" class="space-y-4">
                        <input type="text" id="signupUsername" placeholder="Username" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="email" id="signupEmail" placeholder="Email" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="password" id="signupPassword" placeholder="Password" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <ul id="passwordRequirements" class="text-left text-gray-500 text-sm list-none p-0 -mt-2">
                            <li><span class="mr-2">&#8226;</span>At least 6 characters</li>
                            <li><span class="mr-2">&#8226;</span>At least 1 lowercase letter</li>
                            <li><span class="mr-2">&#8226;</span>At least 1 uppercase letter</li>
                            <li><span class="mr-2">&#8226;</span>At least 1 number</li>
                        </ul>
                        <button type="submit" class="w-full bg-blue-500 text-white p-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Sign Up</button>
                    </form>
                    <p class="text-center text-sm text-gray-600 mt-4">Already have an account? <a href="#" id="showLoginLink" class="text-blue-500 hover:underline">Login</a></p>
                </div>
            </div>
        </div>

        <!-- Task Manager Section -->
        <div id="taskManager" class="hidden">
            <div class="flex items-center justify-end mb-8">
                <button id="logoutBtn" class="bg-red-500 text-white py-2 px-5 rounded-lg font-semibold hover:bg-red-600 transition-colors shadow-md">Log Out</button>
            </div>
            
            <h3 class="text-2xl font-semibold text-gray-700 mt-4 mb-4 border-b pb-2">Create a new task</h3>
            <form id="createForm" class="flex flex-col md:flex-row gap-4 mb-8">
                <input type="text" id="createTitle" placeholder="Task Title" required class="flex-1 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="text" id="createDescription" placeholder="Description" class="flex-1 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="bg-blue-500 text-white p-3 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Add Task</button>
            </form>
            
            <hr class="my-6">
            
            <h3 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">All Tasks</h3>
            <ul id="taskList" class="space-y-4"></ul>
        </div>
        
        <!-- Update Modal -->
        <div id="updateModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-40">
            <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-sm">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Update Task</h3>
                <form id="updateForm" class="space-y-4">
                    <input type="hidden" id="updateId">
                    <input type="text" id="updateTitle" placeholder="New Title" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="updateDescription" placeholder="New Description" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div class="flex justify-end gap-3 mt-4">
                        <button type="button" id="cancelUpdateBtn" class="bg-gray-300 text-gray-700 py-2 px-4 rounded-lg font-semibold hover:bg-gray-400 transition-colors">Cancel</button>
                        <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-600 transition-colors">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // UI Elements
            const authContainer = document.getElementById('authContainer');
            const profileContainer = document.getElementById('profileContainer');
            const loginSection = document.getElementById('loginSection');
            const signupSection = document.getElementById('signupSection');
            const taskManager = document.getElementById('taskManager');
            const showLoginLink = document.getElementById('showLoginLink');
            const showSignupLink = document.getElementById('showSignupLink');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const logoutBtn = document.getElementById('logoutBtn');
            const loginMessage = document.getElementById('loginMessage');
            const signupMessage = document.getElementById('signupMessage');
            const passwordInput = document.getElementById('signupPassword');
            const passwordRequirements = document.getElementById('passwordRequirements').querySelectorAll('li');
            const loginPasswordInput = document.getElementById('loginPassword');
            const loginPasswordToggle = loginSection.querySelector('.password-toggle');
            const profileInitials = document.getElementById('profileInitials');
            const profileUsername = document.getElementById('profileUsername');
            const profileEmail = document.getElementById('profileEmail');
            const createForm = document.getElementById('createForm');
            const taskList = document.getElementById('taskList');
            const updateModal = document.getElementById('updateModal');
            const updateForm = document.getElementById('updateForm');
            const updateIdInput = document.getElementById('updateId');
            const updateTitleInput = document.getElementById('updateTitle');
            const updateDescriptionInput = document.getElementById('updateDescription');
            const cancelUpdateBtn = document.getElementById('cancelUpdateBtn');
            //const API_URL = 'http://localhost:3000/api/tasks';
            const API_URL = 'https://task-manager-2q4w.onrender.com/api/tasks';

            function showSection(section) {
                authContainer.classList.add('hidden');
                taskManager.classList.add('hidden');
                profileContainer.classList.add('hidden');
                loginSection.classList.add('hidden');
                signupSection.classList.add('hidden');

                if (section === 'login') {
                    authContainer.classList.remove('hidden');
                    loginSection.classList.remove('hidden');
                } else if (section === 'signup') {
                    authContainer.classList.remove('hidden');
                    signupSection.classList.remove('hidden');
                } else if (section === 'tasks') {
                    taskManager.classList.remove('hidden');
                    profileContainer.classList.remove('hidden');
                }
            }

            function setToken(token) {
                localStorage.setItem('jwtToken', token);
            }

            function getToken() {
                return localStorage.getItem('jwtToken');
            }

            function removeToken() {
                localStorage.removeItem('jwtToken');
            }
            
            function updateUserProfile(user) {
                profileUsername.textContent = user.username;
                profileEmail.textContent = user.email;
                profileInitials.textContent = user.username.substring(0, 2).toUpperCase();
            }

            loginPasswordToggle.addEventListener('click', () => {
                const type = loginPasswordInput.type === 'password' ? 'text' : 'password';
                loginPasswordInput.type = type;
                loginPasswordToggle.textContent = type === 'password' ? 'Show' : 'Hide';
            });

            passwordInput.addEventListener('keyup', () => {
                const password = passwordInput.value;
                const conditions = [
                    password.length >= 6,
                    /[a-z]/.test(password),
                    /[A-Z]/.test(password),
                    /[0-9]/.test(password)
                ];

                conditions.forEach((isValid, index) => {
                    if (isValid) {
                        passwordRequirements[index].classList.add('text-green-500');
                    } else {
                        passwordRequirements[index].classList.remove('text-green-500');
                    }
                });
            });

            async function showMessage(element, message, isSuccess) {
                element.textContent = message;
                element.classList.remove('hidden', 'bg-red-200', 'text-red-800', 'bg-green-200', 'text-green-800');
                element.classList.add(isSuccess ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800');
            }

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('signupUsername').value;
                const email = document.getElementById('signupEmail').value;
                const password = passwordInput.value;
                try {
                    const response = await fetch(`${API_URL}/signup`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, email, password })
                    });
                    const data = await response.json();
                    showMessage(signupMessage, data.message, response.status === 201);
                    if (response.status === 201) {
                        signupForm.reset();
                        setTimeout(() => showSection('login'), 2000);
                    }
                } catch (error) {
                    console.error('Error during signup:', error);
                    showMessage(signupMessage, 'An unexpected error occurred.', false);
                }
            });

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                try {
                    const response = await fetch(`${API_URL}/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await response.json();
                    if (response.status === 200) {
                        setToken(data.jwt);
                        showSection('tasks');
                        updateUserProfile({ username: data.username, email: data.email });
                        fetchTasks();
                    } else {
                        showMessage(loginMessage, data.message, false);
                    }
                } catch (error) {
                    console.error('Error during login:', error);
                    showMessage(loginMessage, 'An unexpected error occurred.', false);
                }
            });

            logoutBtn.addEventListener('click', async () => {
                removeToken();
                profileUsername.textContent = '';
                profileEmail.textContent = '';
                profileInitials.textContent = '';
                showSection('login');
                taskList.innerHTML = '';
            });

            async function fetchTasks() {
                const token = getToken();
                if (!token) {
                    showSection('login');
                    return;
                }
                
                taskList.innerHTML = '';
                try {
                    const response = await fetch(API_URL, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.status === 401) {
                        removeToken();
                        showSection('login');
                        showMessage(loginMessage, 'Session expired. Please log in again.', false);
                        return;
                    }
                    
                    const data = await response.json();
                    const tasks = data.tasks;
                    
                    if (!tasks || tasks.length === 0) {
                        taskList.innerHTML = '<li class="text-gray-500 italic text-center">No tasks found.</li>';
                        return;
                    }
                    
                    tasks.forEach(task => {
                        const li = document.createElement('li');
                        li.className = 'task-item flex justify-between items-center bg-white p-4 rounded-lg shadow-sm';
                        const taskInfo = document.createElement('div');
                        taskInfo.className = 'flex-1 text-left';
                        taskInfo.innerHTML = `<p class="font-semibold text-gray-800">${task.title}</p><p class="text-sm text-gray-600">${task.description}</p>`;
                        li.appendChild(taskInfo);
                        const actions = document.createElement('div');
                        actions.className = 'flex gap-2';
                        const updateBtn = document.createElement('button');
                        updateBtn.textContent = 'Update';
                        updateBtn.className = 'bg-blue-200 text-blue-800 py-1 px-3 rounded-lg text-sm font-medium hover:bg-blue-300 transition-colors';
                        updateBtn.addEventListener('click', () => showUpdateModal(task.id, task.title, task.description));
                        actions.appendChild(updateBtn);
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.className = 'bg-red-200 text-red-800 py-1 px-3 rounded-lg text-sm font-medium hover:bg-red-300 transition-colors';
                        deleteBtn.addEventListener('click', () => deleteTask(task.id));
                        actions.appendChild(deleteBtn);
                        li.appendChild(actions);
                        taskList.appendChild(li);
                    });
                } catch (e) {
                    console.error('Error fetching tasks:', e);
                    taskList.innerHTML = '<li class="text-red-500 italic text-center">Error loading tasks.</li>';
                }
            }

            function showUpdateModal(id, oldTitle, oldDescription) {
                updateIdInput.value = id;
                updateTitleInput.value = oldTitle;
                updateDescriptionInput.value = oldDescription;
                updateModal.classList.remove('hidden');
            }

            function hideUpdateModal() {
                updateModal.classList.add('hidden');
            }
            
            createForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const token = getToken();
                if (!token) { showSection('login'); return; }
                const title = document.getElementById('createTitle').value;
                const description = document.getElementById('createDescription').value;
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ title, description })
                    });
                    if (response.status === 401) {
                        removeToken();
                        showSection('login');
                        showMessage(loginMessage, 'Session expired. Please log in again.', false);
                        return;
                    }
                    document.getElementById('createTitle').value = '';
                    document.getElementById('createDescription').value = '';
                    fetchTasks();
                } catch (e) {
                    console.error('Error creating task:', e);
                }
            });

            updateForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const token = getToken();
                if (!token) { showSection('login'); return; }
                const id = updateIdInput.value;
                const newTitle = updateTitleInput.value;
                const newDescription = updateDescriptionInput.value;
                const updateData = {};
                if (newTitle.trim() !== '') { updateData.title = newTitle; }
                if (newDescription.trim() !== '') { updateData.description = newDescription; }
                if (Object.keys(updateData).length === 0) {
                    hideUpdateModal();
                    return;
                }
                try {
                    const response = await fetch(`${API_URL}/${id}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(updateData)
                    });
                    if (response.status === 401) {
                        removeToken();
                        showSection('login');
                        showMessage(loginMessage, 'Session expired. Please log in again.', false);
                        return;
                    }
                    hideUpdateModal();
                    fetchTasks();
                } catch (e) {
                    console.error('Error updating task:', e);
                }
            });

            async function deleteTask(id) {
                if (!confirm('Are you sure you want to delete this task?')) { return; }
                
                const token = getToken();
                if (!token) { showSection('login'); return; }
                try {
                    const response = await fetch(`${API_URL}/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.status === 401) {
                        removeToken();
                        showSection('login');
                        showMessage(loginMessage, 'Session expired. Please log in again.', false);
                        return;
                    }
                    fetchTasks();
                } catch (e) {
                    console.error('Error deleting task:', e);
                }
            }

            showLoginLink.addEventListener('click', () => showSection('login'));
            showSignupLink.addEventListener('click', () => showSection('signup'));
            cancelUpdateBtn.addEventListener('click', () => hideUpdateModal());

            // Always start on the login page
            showSection('login');
        });
    </script>
</body>
</html>
